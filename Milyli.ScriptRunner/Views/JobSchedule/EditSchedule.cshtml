@using Newtonsoft.Json
@using Milyli.ScriptRunner.Core.Models
@model JobScheduleModel
@{
    ViewBag.Title = Model.JobSchedule.Name;
    var days = new List<string>() { "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" };
}
<style>
    .required label::after{
        content : " (required)";
    }

    .invalid label{
        font-style : italic;
        color: #af4c4c;
    }

    #mask {
        position:fixed;
        height:100%;
        width:100%;
        top:0px;
        left:0px;
        background: rgba(0,0,0,0.3);
        display : none;
    }

    .day-picker ul {
        list-style-type: none;
        margin: 0px;
        padding: 0px;
    }

    
    .schedule
    {
        display : flex;
        flex-direction : row;
        flex-wrap: wrap;
    }

    .schedule-section
    {
        flex-grow : 1;
    }

    .schedule-footer
    {
        flex-basis : 100%;
    }
    .schedule h4
    {
        font-weight : bold;
    }
    #JobName
    {
        width:80%;
    }
    .job-details label
    {
        min-width: 15em;        
    }
    .job-details label::after
    {
        content : ":";        
    }

    .run-script-container
    {
        display:none;
    }

    button:disabled
    {
        color: gray;
    }

    h3
    {
        padding:5px;
        border-radius: 3px 3px;
        font-weight:normal;
        font-size:12pt;
        width:100%;
        color:white;
        background-color:#173a71;
    }

    td {
        text-align:center;
        width : 25%;
    }

    th.pagination {
        margin:0px;
        text-align : left;
        width:100%;
    }

    .pagination .page-number
    {
        width:70%;
        float : left;
    }

    .pagination .page-size
    {
        width:20%;
        float : right;
    }
</style>

<div id="job-schedule-edit">
    <div id="mask"></div>
        <h3>Job Schedule Details - @Model.JobSchedule.Name</h3>
    <div id="edit-schedule" class="schedule">
        <div class="schedule-section">
            <div class="job-details">
                <h4>Job Details</h4>
                <div data-bind="with: JobSchedule">
                    <label>Job Name</label><input id="JobName" type="text" data-bind="value : Name"  maxlength="255" /><br />
                    <label>Last Execution Time</label><span data-bind="text : LastExecutionTimeString"></span><br />
                    <label>Next Execution Time</label> <span data-bind="text : NextExecutionTimeString"></span><br />
                    <label>Exectues At</label> 
                    <input data-bind="value : ExecutionTimeHours" type="number" min="1" max="12" step="1"/>:<input data-bind="value : ExecutionTimeMinutes" type="number" min="0" max="59" step="1"/>
                    <select data-bind="value:ExecutionTimeMeridian">
                        <option>AM</option>
                        <option>PM</option>
                    </select>
                </div>
                <div data-bind="with: RelativityWorkspace">
                    <label>Workspace</label><a href="@Url.Action("List", "RelativityScript", new { relativityWorkspaceId = Model.RelativityWorkspace.WorkspaceId })">@Model.RelativityWorkspace.Name</a>
                </div>
                <div data-bind="with: RelativityScript">
                    <label>Script</label><a data-bind="text : Name"
                                            href="@Url.Action("Script", "RelativityScript",
                                                 new { relativityWorkspaceId = Model.RelativityWorkspace.WorkspaceId, relativityScriptId = Model.RelativityScript.RelativityScriptId })"></a> (<span data-bind="text : RelativityScriptId"></span>)
                </div>
                <div>
                    <label>Job Status</label><span data-bind="text : JobStatusName"></span>
                    <span data-bind="if : AllowRun">
                        <button data-bind="click: RunJob">Run</button>
                    </span>
                    <span data-bind="ifnot : IsNew">
                        <span data-bind="if: JobSchedule.JobEnabled">
                            <button data-bind="click: DisableJob">Disable</button>
                        </span>
                        <span data-bind="ifnot: JobSchedule.JobEnabled()">
                            <button data-bind="click: EnableJob">Enable</button>
                        </span>
                    </span>
                </div>
            </div>
            <div>
                <h4>Execution Time</h4>
            </div>
            <div class="day-picker">
                <h4>Runs On</h4>
                <ul>
                    @foreach (var day in days)
                    {
                        <li>
                            <input type="checkbox" data-bind="checked: @day" />
                            <label>@day</label>
                        </li>
                    }
                </ul>
            </div>
        </div>
        <div class="schedule-section">
            <h4>Script Inputs</h4>
            <div data-bind="foreach: JobScriptInputs" class="script-inputs">
                <div class="input-container" data-bind="css: { required : IsRequired(), invalid : IsInvalid() }">
                    <label data-bind="text: InputName">
                    </label>
                    <div data-bind="ifnot : HasOptions">
                        <input type="text" data-bind="value: InputValue" />
                    </div>
                    <div data-bind="if: HasOptions">
                        <select data-bind="options: Options, optionsText : 'name', optionsValue : 'value', value: InputValue"></select>
                    </div>
                </div>
            </div>
        </div>
        <div class="schedule-footer">
            <div data-bind="css : { 'error-notification' : IsInvalid() }, text : InvalidText"></div>
            <button id="save-job-schedule" data-bind="click: SaveJobSchedule, disable: IsInvalid, attr {title : InvalidText}">Save</button>
        </div>
        <div class="run-script-container">
            <iframe id="run-script" src="/Relativity/Case/RelativityScript/Run.aspx?AppID=@Model.RelativityWorkspace.WorkspaceId&ArtifactID=@Model.RelativityScript.RelativityScriptId"></iframe>
        </div>
    </div>
    @if (!Model.IsNew)
    {
    <div id="job-schedule-history">
        <h3>Job history</h3>
        <a href="javascript:void window.open('/Relativity/Audit.aspx?AppID=@Model.RelativityWorkspace.WorkspaceId&ArtifactID=@Model.RelativityScript.RelativityScriptId&ArtifactTypeID=@RelativityScript.ScriptArtifactTypeId','audithistory','height=500,width=800,location=no,scrollbars=yes,menubar=no,toolbar=no,status=no,resizable=yes');">Audit (opens in new window)</a>
        <table>
            <thead>
                <tr>
                    <th colspan="3" class="pagination">
                        <div class="page-number">
                            <a href="javascript;" class="fa fa-fast-backward" data-bind="click : GoFirstPage"></a>
                            <a href="javascript;" class="fa fa-backward" data-bind="click : GoPreviousPage"></a>
                            <span data-bind="text : PageNumberText"></span>
                            <a href="javascript;" class="fa fa-forward" data-bind="click : GoNextPage"></a>
                            <a href="javascript;" class="fa fa-fast-forward" data-bind="click : GoLastPage"></a>
                        </div>
                        <div class="page-size">
                            <select data-bind="value : PageSize">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </th>
                </tr>
                <tr>
                    <th>Start Time</th>
                    <th>Running Time, Seconds</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody data-bind="foreach: JobHistory">
                <tr>
                    <td data-bind="text : StartTimeString"></td>
                    <td data-bind="text : Runtime"></td>
                    <td>
                        <span data-bind="if : HasError">
                            <span data-bind="ResultText"></span>
                        </span>
                        <span data-bind="ifnot : HasError">
                            Success
                        </span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    }
</div>
@Scripts.Render("~/bundles/JobSchedule")
@section Scripts
{
    <script type="text/javascript">
        //Used by the RunScript iframe.  Yes this is janky.
        function ResetTimeout()
        {

        };

        function unmask()
        {
            $("#mask").css("display", "none");
        };

        function mask()
        {
            $("#mask").css("display", "block");
        };

        function MakeOptionsArray($inputContainerElement)
        {
            return $inputContainerElement.find("option")
                .map(function(idx, element)
                {
                    var $element = $(element);
                    return {
                        value: $element.attr("value"),
                        name : $element.text()
                    };
                })
                .toArray();
        }

        //Yes we're finding script input DDLs by scraping. Yes this is janky. I have tried looking for a better way to grab input values in a better manner
        //but none of the RSAPI mechanisms for Relativity Scripts seems geared toward populating input lists.
        function getInputValues()
        {
            return $("#run-script").contents()
                                    .find("table.fieldTable")
                                    .map(function(idx, element)
                                    {
                                        var $element = $(element);
                                        var inputId = $element.find("tr:first").attr("id");
                                        var options = MakeOptionsArray($element);
                                        return {
                                            inputId : inputId,
                                            options : options
                                        };
                                    })
            .toArray()
            .reduce(function(accum, curr){
                if(curr.options && curr.options.length)
                {
                    accum[curr.inputId] = curr.options;
                }
                return accum;
            },{});
        };


        var days  = @Html.Raw(JsonConvert.SerializeObject(days));
        var JobStatus =
        {
            "0" : "Idle",
            "1" : "Waiting for agent",
            "2" : "Running"
        };

        function error (responseData)
        {
            var message = responseData.responseJSON && responseData.responseJSON.Message ?
                responseData.responseJSON.Message
                :
                responseData.responseText;
            alert(message);
        };

        toTimeString = function(timeString)
        {
            if(timeString)
            {
                var date = new Date(timeString.replace('T', ' '));
                if(!isNaN(date.getDay()))
                {
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                }
            }
            return "Unknown";
        }


        var viewmodelContainer = new JobScheduleViewModel(
            @Html.Raw(JsonConvert.SerializeObject(Model)),
            {
                Run : "@Url.Action("Run")",
                Save : "@Url.Action("Save")",
                Index : "@Url.Action("Index")"
            });

        $("#run-script").on("load", function()
        {
            viewmodelContainer.UpdateOptions(getInputValues());
            ko.applyBindings(viewmodelContainer.GetViewModel(), $("#edit-schedule")[0]);
        });

        if(!viewmodelContainer.IsNew())
        {
            var jobHistoryBuilder = new JobHistoryLoader("@Url.Action("JobHistory")", @Model.JobSchedule.Id);
            var jobHistoryViewModel = new JobHistoryViewModel(jobHistoryBuilder, function(historyViewModel)
            {
                ko.applyBindings(historyViewModel, $("#job-schedule-history")[0]);
            });
        }

    </script>
}

